FROM node:14 AS staging
WORKDIR /src
RUN apt update -y && apt install findutils -y
COPY client .
RUN mkdir -p ./pkg/ \
    && find . -type d -name node_modules -prune -false -o \( -name "package.json" -o -name "yarn.lock" -o -name "package-lock.json" \)  -exec install -D '{}' './pkg/{}' \;

FROM node:14 AS web
WORKDIR /app
ENV VUE_APP_BASE_URL $VUE_APP_BASE_URL
WORKDIR /app
RUN apt update -y && apt install gettext -y
COPY --from=staging /src/pkg ./
RUN yarn install --non-interactive
COPY client .
RUN yarn standalone

FROM python:3.9
WORKDIR /srv

EXPOSE 80

ENV JSFOLDER=/usr/share/nginx/html/js/*.js

ENV SOCKETIO_HOST=http://localhost:80
ENV REDIS_HELPER_HOST=http://owncloud_redis
ENV REDIS_HELPER_PORT=6379
ENV PROMETHEUS_MULTIPROC_DIR=/tmp

RUN apt update -y && apt install nginx -y
RUN mkdir -p /run/nginx
RUN mkdir -p /var/lib/nginx/tmp
RUN pip install pipenv supervisor==4.2.2

COPY ./server/requirements.txt ./server/Pipfile ./server/Pipfile.lock /srv/
RUN pipenv install --system

COPY --from=web /app/packages/standalone/dist /usr/share/nginx/html
COPY ./setup/misc/supervisord.rds.conf /etc/supervisor/supervisord.conf
COPY ./setup/misc/start-nginx.nginx.sh /usr/bin/start-nginx.sh
RUN chmod +x /usr/bin/start-nginx.sh
COPY ./setup/misc/nginx/gunicorn.conf /etc/nginx/nginx.conf
COPY ./server/starter.py /srv/
COPY ./server/src /srv/src

ENTRYPOINT [ "supervisord", "-c" , "/etc/supervisor/supervisord.conf"]